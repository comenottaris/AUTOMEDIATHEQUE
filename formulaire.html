<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Proposer un automédia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="assets/automediatheque.css" />
    
    <style>
      body {
        padding: 0 40px;
      }
      @media (max-width: 768px) {
        body {
          padding: 0 10px;
        }
      }
      /* Style pour le menu de navigation */
      .am-nav {
        background-color: #f5f5f5;
        padding: 1rem 0;
        margin-bottom: 2rem;
        border-bottom: 2px solid #e0e0e0;
      }
      .am-nav-inner {
        display: flex;
        justify-content: center;
        gap: 2rem;
        flex-wrap: wrap;
      }
      .am-nav-link {
        color: #333;
        text-decoration: none;
        font-weight: 500;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        transition: all 0.2s ease;
      }
      .am-nav-link:hover {
        background-color: #e0e0e0;
        color: #000;
      }
      .am-nav-link.active {
        background-color: #d00;
        color: #fff;
      }
      .am-nav-link.active:hover {
        background-color: #b00;
      }
    </style>
  </head>
  <body>

    <!-- Menu de navigation -->
    <nav class="am-nav">
      <div class="am-nav-inner">
        <a href="index.html" class="am-nav-link">Accueil</a>
        <a href="formulaire.html" class="am-nav-link active">Proposer un automédia</a>
        <a href="ressources.html" class="am-nav-link">Ressources</a>
      </div>
    </nav>
    
    <div class="am-page">
      <header class="am-hero am-hero--center">
        <div class="am-hero-inner">
          <p class="am-kicker">Ressources · Automédias</p>
          <h1 class="am-hero-title">Proposer un automédia</h1>
          <p class="am-hero-lead">
            Ce formulaire permet de proposer un automédia à ajouter à la base.
          </p>
          <p class="am-hero-text">
            Aucune donnée personnelle n’est demandée. Tu peux contribuer de façon anonyme.
          </p>
        </div>
      </header>

      <hr class="am-divider" />

      <main class="am-main">
        <section class="am-section">
          <div class="am-section-inner">
            <p class="am-section-intro">
              Les propositions seront stockées dans une base Supabase (open
              source), puis synchronisées automatiquement dans
              <code>data/propositions.json</code>.
            </p>

            <form id="proposition-form" class="am-form">
              <fieldset class="am-fieldset">
                <legend class="am-section-title">Informations principales</legend>

                <label class="am-field">
                  <span class="am-field-label">Nom de l’automédia *</span>
                  <input class="am-input" type="text" name="name" required />
                </label>

                <label class="am-field">
                  <span class="am-field-label">URL principale *</span>
                  <input
                    class="am-input"
                    type="url"
                    name="url"
                    placeholder="https://…"
                    required
                  />
                </label>

                <label class="am-field">
                  <span class="am-field-label">
                    Type 
                  </span>
                  <input
                    class="am-input"
                    type="text"
                    name="type"
                    placeholder="site, radio, Instagram, zine, canal Telegram, etc."
                  />
                </label>

                <label class="am-field">
                  <span class="am-field-label">Pays / zone</span>
                  <input
                    class="am-input"
                    type="text"
                    name="country"
                    placeholder="France, International, Kurdistan…"
                  />
                </label>

                <label class="am-field">
                  <span class="am-field-label">Langues</span>
                  <input
                    class="am-input"
                    type="text"
                    name="languages"
                    placeholder="fr, en, es… (séparées par des virgules)"
                  />
                </label>
              </fieldset>

              <fieldset class="am-fieldset">
                <legend class="am-section-title">Description</legend>

                <label class="am-field">
                  <span class="am-field-label">
                    Brève description de l’automédia *
                  </span>
                  <textarea
                    class="am-textarea"
                    name="description"
                    rows="5"
                    required
                  ></textarea>
                </label>

                <label class="am-field">
                  <span class="am-field-label">
                    Notes complémentaires (optionnel)
                  </span>
                  <textarea
                    class="am-textarea"
                    name="notes"
                    rows="3"
                    placeholder="Contexte, remarques, précisions…"
                  ></textarea>
                </label>
              </fieldset>

              <!-- Honeypot anti-spam -->
              <div style="position:absolute; left:-9999px;" aria-hidden="true">
                <label>
                  Ne pas remplir ce champ (anti‑spam)
                  <input
                    type="text"
                    name="website"
                    tabindex="-1"
                    autocomplete="off"
                  />
                </label>
              </div>

              <button type="submit" class="am-button">
                Envoyer la proposition
              </button>

              <p id="form-message" class="am-hero-note"></p>
            </form>
          </div>
        </section>
      </main>

      <footer class="am-footer">
        <p class="am-footer-text">
          Retour à la liste : <a href="index.html">Automédiathèque</a>.
        </p>
      </footer>
    </div>

    <script type="module">
      // À REMPLACER par ton projet Supabase
      const SUPABASE_URL = "https://fnxxhuyqhhpfjvgmcbjz.supabase.co";
      const SUPABASE_ANON_KEY = "sb_publishable_uyzjAWCUrveeUHsP0m-X3Q_QGQ21Rkw";

      const form = document.getElementById("proposition-form");
      const messageEl = document.getElementById("form-message");

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        messageEl.textContent = "Envoi en cours…";

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // honeypot : si rempli, on ignore (bot)
        if (data.website) {
          messageEl.textContent = "Merci.";
          form.reset();
          return;
        }

        const payload = {
          name: data.name,
          url: data.url,
          type: data.type || null,
          country: data.country || null,
          languages: data.languages || null,
          description: data.description,
          notes: data.notes || null
        };

        try {
          const res = await fetch(`${SUPABASE_URL}/rest/v1/propositions`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              Prefer: "return=minimal"
            },
            body: JSON.stringify(payload)
          });

          if (!res.ok) {
            const text = await res.text();
            console.error("Erreur Supabase:", res.status, text);
            throw new Error("Échec de l’enregistrement");
          }

          messageEl.textContent =
            "Merci ! Ta proposition sera bientôt visible dans la base !";
          form.reset();
        } catch (err) {
          console.error(err);
          messageEl.textContent =
            "Une erreur est survenue pendant l’envoi. Désolé, c'est sûrement un problème technique de mon côté, il va falloir réessayer plus tard...";
        }
      });
    </script>
  </body>
</html>
